#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

include /usr/share/dpkg/default.mk

export GOPATH := $(CURDIR)/go
export PATH   := $(GOPATH)/bin:$(CURDIR)/ui/node_modules/yarn/bin:$(PATH)
export GOMAXPROCS=1
export DEB_BUILD_MAINT_OPTIONS = hardening=+all
export DH_GOLANG_EXCLUDES = demo
export DH_GOLANG_INSTALL_EXTRA = \
    client/getter/test-fixtures \
    client/driver/test-resources \
    command/agent/test-resources \
    command/agent/config-test-fixtures \
    jobspec/test-fixtures

%:
	dh $@ --buildsystem=golang --with=golang,systemd --builddirectory=_build --parallel

override_dh_auto_build:
	mkdir -p go/src/github.com/hashicorp
	ln -sfT $(CURDIR) $(GOPATH)/src/github.com/hashicorp/nomad
	cd $(GOPATH)/src/github.com/hashicorp/nomad && make bootstrap
	cd $(GOPATH)/src/github.com/hashicorp/nomad && make release ALL_TARGETS=linux_amd64 GO_TAGS=

# no tests until we figure out how to run the test suite without sudo
override_dh_auto_test:

override_dh_clean:
	dh_clean
	$(RM) -r _build ui/node_modules go

override_dh_auto_install:
	dh_auto_install --destdir=debian/tmp

override_dh_installinit:
	dh_installinit --no-start

override_dh_systemd_start:
	dh_systemd_start --no-start

override_dh_systemd_enable:
	dh_systemd_enable --no-enable
